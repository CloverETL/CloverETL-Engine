<?xml version="1.0" encoding="us-ascii"?>
<project name="cloveretl.engine" default="build" basedir=".">
	
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	  <classpath>
	    <pathelement location="ant-contrib.jar"/>
	  </classpath>
	</taskdef>
	
	<!-- =========================== VERSIONs =========================== -->
	<property name="major_version" value="2"/>
	<property name="minor_version" value="1"/>
	<property name="revision_version" value="0"/>
	
	
	<!-- =========================== DEFAULT DIRECTORIES =========================== -->
	<property name="dir.bin.default" value="${basedir}/bin"/>
	<property name="dir.doc.default" value="${basedir}/javadoc"/>
	<property name="dir.dist.default" value="${basedir}/build"/>
	<property name="dir.lib" value="${basedir}/lib"/>
	<property name="dir.docs" value="${basedir}/docs"/>
	<property name="dir.src" value="src"/>
	<property name="dir.src.tmp" value="src_tmp"/>
	
	<!--load external properties-->
	<property file="build.properties"/>
		
	<!-- =========================== LIBRARIES ============================= -->
	<fileset id="engine-libs" dir="${dir.lib}">
		<include name="**/*.jar"/>
	</fileset>

		<!-- =========================== TARGETS ============================== -->
	<target name="build" depends="compile,package" description="Compiles sources and creates a JAR file">
		<foreach list="${plugin.list}" inheritall="true" target="plugin.build" param="plugin.dir"/>
	</target>

	<target name="plugin.build" description="Private target for building usage. Don't call direct.">
		<echo message="Building plugin - ${plugin.dir}"/>
		<ant dir="${plugin.dir}" inheritAll="false">
			<property name="dir.dist" value="${dir.dist}"/>
			<property name="major_version" value="${major_version}"/>
			<property name="minor_version" value="${minor_version}"/>
			<property name="revision_version" value="${revision_version}"/>
		</ant>
	</target>

	<target name="dist.src"  description="Creates source distribution">
		<property name="src.distribution.dir" value="${basedir}/dist.src"/>
		<delete dir="${src.distribution.dir}" />
		<mkdir dir="${src.distribution.dir}/cloverETL"/>
		
		<!-- call source target for all plugins -->
		<foreach list="${plugin.list}" inheritall="true" target="plugin.src" param="plugin.dir"/>

		<!-- copy source for engine itself -->
		<property name="src.distribution.dir.engine" value="${src.distribution.dir}/cloverETL/cloveretl.engine"/>

		<copy todir="${src.distribution.dir.engine}/src">
			<fileset dir="${dir.src}" />
		</copy>

		<copy todir="${src.distribution.dir.engine}/docs">
			<fileset dir="${dir.docs}" />
		</copy>
		
		<copy todir="${src.distribution.dir.engine}/lib">
			<fileset dir="${dir.lib}" />
		</copy>

		<copy todir="${src.distribution.dir.engine}/plugins">
			<fileset dir="plugins" />
		</copy>

		<copy todir="${src.distribution.dir.engine}/test">
			<fileset dir="test" />
		</copy>

		<copy todir="${src.distribution.dir.engine}">
			<fileset file="ant-contrib.jar" />
			<fileset file="build.xml" />
			<fileset file="build.properties" />
		</copy>
		
		<!-- create zip package for source distribution -->
		<zip destfile="${src.distribution.dir}/cloverETL.src.rel-${major_version}-${minor_version}-${revision_version}.zip" basedir="${src.distribution.dir}"/>

		<delete dir="${src.distribution.dir}/cloverETL"/>
	</target>

	<target name="plugin.src" description="Private target for copy source of plugin. Don't call direct.">
		<echo message="Copy source from plugin - ${plugin.dir}"/>
		<ant dir="${plugin.dir}" target="dist.src" inheritAll="false">
			<property name="dist.src" value="${src.distribution.dir}/cloverETL"/>
		</ant>
	</target>

	<target name="dist.bin" depends="build" description="Creates binary distribution">
		<property name="distribution.dir" value="${basedir}/dist"/>
		<delete dir="${distribution.dir}" />
		
		<!-- binary distribution -->
		<mkdir dir="${distribution.dir}/cloverETL"/>

		<copy todir="${distribution.dir}/cloverETL">
			<fileset dir="${dir.dist}" />
		</copy>

		<!-- create zip distribution package -->
		<zip destfile="${distribution.dir}/cloverETL.rel-${major_version}-${minor_version}-${revision_version}.zip" basedir="${distribution.dir}"/>

		<delete dir="${distribution.dir}/cloverETL"/>
	</target>


	<!-- The "clean" target deletes previously compiled files. -->
	<target name="clean" depends="checkproperties" description="Delete old compiled files">
		<delete dir="${dir.bin}"/>
		<delete dir="${dir.dist}"/>
	</target>

	<!-- Target sets directory-properties unless they have been defined (in parent ant build) -->
	<target name="checkproperties" description="Sets properties unless they have been defined in parent ant build">
		<tstamp>
			<format property="TODAY" pattern="dd/MM/yyyy HH:mm:ss" locale="en" />
		</tstamp>
		
		<condition property="dir.bin" value="${dir.bin.default}">
			<not>
				<isset property="dir.bin"/>
			</not>
		</condition>
		
		<condition property="dir.doc" value="${dir.doc.default}">
			<not>
				<isset property="dir.doc"/>
			</not>
		</condition>
		
		<condition property="dir.dist" value="${dir.dist.default}">
			<not>
				<isset property="dir.dist"/>
			</not>
		</condition>

		<echo message="Using directory for classes: ${dir.bin}"/> 
		<echo message="Using directory for javadoc: ${dir.doc}"/>
		<echo message="Using directory for dist: ${dir.dist}"/>
	</target>
	
	<!-- compile temp copy of source -->
	<target name="compile" depends="checkproperties,copy_src" description="Compile sources">
		<!-- Create directory for binaries. -->
		<mkdir dir="${dir.bin}"/>
		
		<!-- Compile sources -->
		<javac debug="true" destdir="${dir.bin}" target="1.5" source="1.5">
			<classpath>
				<pathelement path="${tools}"/>
				<pathelement path="${commons-logging}"/>
				<pathelement path="${log4j}"/>
				<fileset refid="engine-libs"/>			
			</classpath>
			<src path="${dir.src.tmp}"/>
			<exclude name="test/**/*"/>
		</javac>
		
		<!-- copy resources -->
		<copy todir="${dir.bin}">
		    <fileset dir="${dir.src}">
			      <exclude name="**/*.java"/>
			      <exclude name="**/svn/**"/>
		    </fileset>
		  </copy>
		
		<!-- delete source temp directory -->
		<delete dir="${dir.src.tmp}"/>
	</target>

	<!-- pack binary result of compile to jar file -->
	<target name="package" depends="compile">
		<!-- Create directory for dist. -->
		<mkdir dir="${dir.dist}"/>
		
		<jar destfile="${dir.dist}/cloveretl.engine.jar" basedir="${dir.bin}">
			<include name="**/*"/>
			<exclude name="test/**/*"/>
		</jar>
		
		<!-- copy all libraries from lib directory -->
		<copy todir="${dir.dist}/lib">
			<fileset dir="${dir.lib}"/>
		</copy>

		<!-- copy all documents from docs directory -->
		<copy todir="${dir.dist}/docs">
			<fileset dir="${dir.docs}"/>
		</copy>
	</target>
	
	<!-- ask user for MAJOR and MINOR release number -->
	<target name="set_revision">
		<buildnumber file="build.number" />
		<input message="Engine - Please enter MAJOR release number:"	addproperty="major_version" />
		<input message="Engine - Please enter MINOR release number:"	addproperty="minor_version" />
		<input message="Engine - Please enter REVISION release number:"	addproperty="revision_version" />
	</target>
	
	<!-- make a temp copy of source - necessary for substitute release number constants in source code -->
	<target name="copy_src" depends="set_revision">
		<echo message="Copying source code.." />
		<copy todir="${dir.src.tmp}">
			<fileset dir="${dir.src}" />
			<filterset>
				<filter token="MAJOR_VERSION" value="${major_version}" />
				<filter token="MINOR_VERSION" value="${minor_version}" />
				<filter token="BUILD_NUMBER" value="${build.number}" />
				<filter token="BUILD_TIME" value="${TODAY}" />
			</filterset>
		</copy>
	</target>
	
	<!-- The "javadoc" target generates JavaDoc documentation. -->
	<!--target name="javadoc" depends="checkproperties" description="Create Javadoc API documentation">
        <javadoc destdir="${dir.doc}" access="public" use="true"
        	notree="false" nonavbar="false" noindex="false" splitindex="true"
        	author="true" version="true" nodeprecatedlist="false"
        	nodeprecated="false" packagenames="org.jetel.*"
        	sourcepath="${dir.src}">
        	<sourcepath path="../cloveretl.connection/src"/>
			<doctitle><![CDATA[<h1>CloverETL: Java ETL framework </h1>]]></doctitle>
			<bottom>
				<![CDATA[Copyright &#169; 2002-2005 Opentech s.r.o]]>
			</bottom>
		</javadoc>
	</target-->

	<target name="javadoc" depends="checkproperties,set_revision" description="Create Javadoc API documentation">
		<echo message="Building code documentation..." />
		<property name="dist.subdir" value="cloverETL"/>
		<delete dir="${dir.doc}" />
		<mkdir dir="${dir.doc}/${dist.subdir}" />
		<javadoc destdir="${dir.doc}/${dist.subdir}" packagenames="*"
			author="true">
			<sourcepath path="${dir.src}"/>
			<sourcepath path="../cloveretl.component/src"/>
			<sourcepath path="../cloveretl.connection/src"/>
			<sourcepath path="../cloveretl.sequence/src"/>
			<sourcepath path="../cloveretl.lookup/src"/>
			<sourcepath path="../cloveretl.thirdparty/src"/>
			<!--sourcepath path="../cloveretl.engine.oracle/src"/-->
			<doclet name="com.sun.tools.doclets.standard.Standard">
				<param name="-breakiterator" value="on" />
				<!-- Following tag definition is here to get rid of complains produced by standard doclet-->
				<param name="-tag" value="revision" />
			</doclet>
			<doctitle><![CDATA[<h1>CloverETL: Java ETL framework</h1><h3>version: ]]>${major_version}.${minor_version}<![CDATA[</h3>]]></doctitle>
			<bottom>
				<![CDATA[<address>Copyright &#169; 2002-2006 Javlin consulting s.r.o</address>]]>
			</bottom>
		</javadoc>
		
		<!-- create zip package for javadoc -->
		<zip destfile="${dir.doc}/cloverETL.javadoc.rel-${major_version}-${minor_version}-${revision_version}.zip" basedir="${dir.doc}"/>

		<delete dir="${dir.doc}/${dist.subdir}"/>
	</target>
	
</project>