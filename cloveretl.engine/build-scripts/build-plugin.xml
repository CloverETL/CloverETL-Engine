<?xml version="1.0" encoding="us-ascii"?>
<project name="cloveretl plugin" default="build" basedir=".">

	<!-- =========================== DEFAULT DIRECTORIES =========================== -->
	<basename property="plugin.name" file="${basedir}" />
	<propertyregex property="plugin.dir.name"
		input="${plugin.name}"
		regexp="cloveretl\.(.*)"
		select="org.jetel.\1" />

	<property name="dir.src" value="${basedir}/src"/>
	<property name="dir.lib" value="${basedir}/lib"/>
	<property name="dir.doc" value="${basedir}/doc"/>
	<property name="dir.dist" value="${basedir}/dist"/>

	<property name="dir.engine" value="${basedir}/../cloveretl.engine"/>
	<property file="${dir.engine}/build.properties"/>		
	<property name="dir.engine.lib" value="${dir.engine}/lib"/>

	<property name="dir.build" value="${basedir}/build"/>
	<property name="dir.classes" value="${dir.build}/classes"/>
	<property name="dir.src.improved" value="${dir.build}/src-improved"/>
	<property name="required.plugins.file" value="${dir.build}/required-plugins.txt"/>

	<!--load external properties-->

	<!-- =========================== LIBRARIES ============================= -->
	<fileset id="engine-libs" dir="${dir.engine.lib}">
		<include name="**/*.jar"/>
	</fileset>


	
	<!-- =========================== TARGETS ============================== -->
	<target name="build" depends="compile,package" description="Compiles sources and creates a JAR file"/>

	<target name="init">
		<tstamp>
			<format property="TODAY" pattern="dd/MM/yyyy HH:mm:ss" locale="en" />
		</tstamp>

		<echo message="Using directory for classes: ${dir.classes}"/>
		<echo message="Using directory for javadoc: ${dir.doc}"/>
		<echo message="Using directory for dist: ${dir.dist}"/>

		<mkdir dir="${dir.build}"/>

		<if><available file="${dir.lib}"/>
			<then>
				<echo message="Plugin has own libraries in ${dir.engine.lib}"/>
				<fileset id="plugin-libs" dir="${dir.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</then>
			<else>
				<echo message="Plugin has no own library"/>
				<!-- define empty fileset -->
				<fileset id="plugin-libs" dir="${basedir}">
					<include name=""/>
				</fileset>
			</else>
		</if>
		
	</target>

	<!-- ask user for MAJOR and MINOR release number -->
	<target name="revision-set">
		<input message="Plugin ${plugin.name} - Please enter MAJOR release number:"	addproperty="major_version" />
		<input message="Plugin ${plugin.name} - Please enter MINOR release number:"	addproperty="minor_version" />
		<input message="Engine - Please enter REVISION release number:"	addproperty="revision_version" />
		<property name="build.number" value="devel"/>
	</target>

	<!-- make a temp copy of source - necessary for substitute release number constants in source code -->
	<target name="improve-java-sources" depends="revision-set">
		<copy todir="${dir.src.improved}">
			<fileset dir="${dir.src}" />
			<filterset>
				<filter token="MAJOR_VERSION" value="${major_version}" />
				<filter token="MINOR_VERSION" value="${minor_version}" />
				<filter token="BUILD_NUMBER" value="build.number" />
				<filter token="BUILD_TIME" value="${TODAY}" />
			</filterset>
		</copy>
	</target>

	<target name="find-required-plugins" depends="init">
		<!--<propertyregex property="dir.dist.escaped"
		              input="${dir.dist}"
		              regexp="(.*)a(.*)"
		              select="\1vv\2"
					  global="true"
		              casesensitive="false" />
		<echo> dddmessage=${dir.dist.escaped}</echo>

		<fail message="${dir.dist.escaped}"/-->
		<xslt 
			style="${dir.engine}/build-scripts/required-plugins.xsl"
			in="${basedir}/plugin.xml"
			out="${required.plugins.file}"
			>
			<param name="separator" expression=","/>
			<param name="dist" expression="${dir.dist}"/>
		</xslt>
		<property file="${required.plugins.file}"/>
		
		<property name="cp.compile" value="${dir.dist}${engine.dist}${required.plugins.dist}" />
		
		<echo>required.plugins=${required.plugins}</echo>
	</target>
	
	<target name="compile" depends="init,improve-java-sources,find-required-plugins" description="Compile sources">
		<!-- Create directory for binaries. -->
		<mkdir dir="${dir.classes}"/>

		<echo message="Compile classes from ${dir.src.improved} with classpath ${cp.compile}"/>
		<!-- Compile sources -->
		<javac 
				debug="true" 
				destdir="${dir.classes}"
				source="1.5"
				target="1.5"  
				classpath="${cp.compile}">
			<classpath>
				<fileset refid="plugin-libs"/>
				<fileset refid="engine-libs"/>
			</classpath>
			<src path="${dir.src.improved}"/>
		</javac>

		<!-- copy resources -->
		<copy todir="${dir.classes}">
			<fileset dir="${dir.src}">
				<exclude name="**/*.java" />
				<exclude name="**/svn/**" />
			</fileset>
		</copy>

	</target>

	<!-- pack binary result of compile to jar file -->
	<target name="package" depends="compile">
		<!-- Create plugin directory. -->
		<mkdir dir="${dir.dist}/plugins/${plugin.dir.name}"/>

		<jar destfile="${dir.dist}/plugins/${plugin.dir.name}/${plugin.name}.jar" basedir="${dir.classes}">
			<include name="**/*"/>
		</jar>
		<!-- copy plugin manifest -->
		<copy todir="${dir.dist}/plugins/${plugin.dir.name}" file="plugin.xml"/>
		
		<!-- copy all libraries from lib directory -->
		<if><available file="${dir.lib}"/>
			<then>
				<copy todir="${dir.dist}/plugins/${plugin.dir.name}/lib">
					<fileset dir="${dir.lib}">
						<include name="**/*"/>
					</fileset>
				</copy>
			</then>
		</if>
	</target>

	<target name="dist.src"  description="Creates source distribution">

		<copy todir="${dist.src}/${plugin.name}/src">
			<fileset dir="${dir.src}" />
		</copy>

		<copy todir="${dist.src}/${plugin.name}/lib">
			<fileset dir="${dir.lib}" />
		</copy>

		<copy todir="${dist.src}/${plugin.name}">
			<fileset file="build.xml" />
			<fileset file="plugin.xml" />
		</copy>
	</target>

	<target name="clean" depends="init" description="Delete previously build files">
		<delete dir="${dir.build}"/>
	</target>
	
</project>